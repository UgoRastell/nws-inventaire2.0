name: deploy

on: 
  push:
    branches:
      - 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo docker compose up -d 
      - run: sudo docker compose exec php composer install
      - run: sudo docker compose exec php symfony console doctrine:database:create --env=test
      - run: sudo docker compose exec php symfony console doctrine:schema:update --env=test --force
      - run: sudo docker compose exec php php bin/phpunit
      - run: |
          sudo mkdir -p ~/.ssh
          sudo ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          sudo chmod 644 ~/.ssh/known_hosts

      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - run: ssh ${{ secrets.SSH_USER}}@${{ secrets.SSH_HOST }} "cd nws-inventaire2.0 && sudo git pull"
      - run: ssh ${{ secrets.SSH_USER}}@${{ secrets.SSH_HOST }} "cd nws-inventaire2.0 && sudo docker compose up -d --build --force-recreate"